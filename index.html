<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Headcount ‚Äì Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#050816;
      --panel:#0b1220;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.15);
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f97373;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%);
      color:var(--ink);
      min-height:100vh;
      padding:16px;
    }
    .app{
      max-width:1400px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      font-size:1.4rem;
      letter-spacing:.03em;
    }
    .subtitle{
      font-size:.85rem;
      color:var(--muted);
    }
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    select,input,button{
      background:rgba(15,23,42,.9);
      color:var(--ink);
      border:1px solid rgba(148,163,184,.6);
      border-radius:999px;
      padding:6px 12px;
      font-size:.8rem;
      outline:none;
    }
    button.primary{
      border-color:var(--accent);
      background:var(--accent-soft);
      cursor:pointer;
    }
    main{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .panel{
      background:rgba(15,23,42,.9);
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.4);
      padding:12px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
    }
    .panel h2{
      font-size:.95rem;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .panel h2 span.label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .summary-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:700px){
      .summary-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    .card{
      background:radial-gradient(circle at top,var(--accent-soft),rgba(15,23,42,.95));
      border-radius:var(--radius);
      padding:10px 12px;
      border:1px solid rgba(148,163,184,.4);
    }
    .card-label{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .card-value{
      font-size:1.3rem;
      margin-top:4px;
    }
    .card-extra{
      font-size:.75rem;
      margin-top:2px;
      color:var(--muted);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.76rem;
    }
    th,td{
      padding:6px 6px;
      text-align:right;
      border-bottom:1px solid rgba(31,41,55,.8);
      white-space:nowrap;
    }
    th:first-child, td:first-child{
      text-align:left;
    }
    th{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
      position:sticky;
      top:0;
      background:rgba(15,23,42,0.98);
      z-index:1;
    }
    tbody tr:nth-child(even){
      background-color:rgba(15,23,42,.7);
    }
    tbody tr:hover{
      background-color:rgba(30,64,175,.55);
      cursor:pointer;
    }
    .muted{color:var(--muted);}
    .placeholder{
      font-size:.8rem;
      color:var(--muted);
      padding:8px 2px 2px;
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.4);
      font-size:.7rem;
    }
    .pill strong{color:var(--accent);}
    .pill.sm{font-size:.68rem;padding:2px 6px;}
    .pill.red{border-color:var(--danger);color:#fecaca;}
    .scroll-x{
      overflow:auto;
      max-height:420px;
    }

    /* Month-detail role summary + overload */
    .month-roles-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:8px;
      margin-bottom:6px;
      font-size:.72rem;
    }
    .role-card{
      border-radius:10px;
      border:1px solid rgba(148,163,184,.4);
      padding:6px 8px;
      background:rgba(15,23,42,.85);
    }
    .role-card .role-name{
      font-size:.72rem;
      font-weight:600;
      margin-bottom:2px;
    }
    .role-card .role-values{
      display:flex;
      justify-content:space-between;
      font-size:.7rem;
    }
    .role-gap{
      margin-top:2px;
      font-size:.68rem;
      color:var(--muted);
    }
    .role-card.missing{border-color:#f97373;}
    .role-card.excess{border-color:#22c55e;}
    .overload-list{
      margin:4px 0 0 16px;
      padding-left:0;
      font-size:.72rem;
    }
    .overload-list li{
      margin-bottom:2px;
    }

    /* Project staffing panel */
    .project-staffing{
      margin-top:10px;
      border-top:1px solid rgba(30,64,175,.6);
      padding-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:.75rem;
    }
    .project-staffing-header{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .project-staffing-header span{
      font-size:.78rem;
      color:var(--muted);
    }
    .project-roles-list{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .proj-role-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:flex-start;
      justify-content:space-between;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.4);
      padding:6px 8px;
      background:rgba(15,23,42,.8);
    }
    .proj-role-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:140px;
    }
    .proj-role-name{
      font-weight:600;
      font-size:.78rem;
    }
    .proj-role-meta{
      font-size:.7rem;
      color:var(--muted);
    }
    .proj-role-assigned{
      font-size:.7rem;
    }
    .proj-role-actions{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      align-items:center;
    }
    .proj-role-actions select{
      font-size:.72rem;
      padding:4px 8px;
    }
    .proj-role-actions button{
      font-size:.72rem;
      padding:4px 10px;
      border-radius:999px;
      cursor:pointer;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Project Headcount ‚Äì Command Center</h1>
      <div class="subtitle">Supabase ¬∑ Monthly demand ¬∑ Focus roles ¬∑ 2025‚Äì2027</div>
    </div>
    <div class="filters">
      <select id="regionFilter">
        <option value="all">All regions</option>
      </select>
      <select id="countryFilter">
        <option value="all">All countries</option>
      </select>
      <select id="techFilter">
        <option value="all">All technologies</option>
      </select>
      <select id="yearFilter">
        <option value="all">All years</option>
      </select>
      <button class="primary" id="refreshBtn">Refresh data</button>
    </div>
  </header>

  <main>
    <!-- OVERVIEW -->
    <section class="panel">
      <h2>
        Overview
        <span class="label">Snapshot</span>
      </h2>
      <div class="summary-grid">
        <div class="card">
          <div class="card-label">Roles</div>
          <div class="card-value" id="summaryRoles">‚Äì</div>
          <div class="card-extra muted">from roles_capacity</div>
        </div>
        <div class="card">
          <div class="card-label">People</div>
          <div class="card-value" id="summaryPeople">‚Äì</div>
          <div class="card-extra muted">internal + OE</div>
        </div>
        <div class="card">
          <div class="card-label">Projects</div>
          <div class="card-value" id="summaryProjects">‚Äì</div>
          <div class="card-extra muted" id="summaryProjectsExtra">filtered by region / country / tech</div>
        </div>
      </div>
      <div class="placeholder">
        Monthly demand below is computed from: project dates √ó stage mapping √ó Role Stage Demand Matrix.
      </div>
    </section>

    <!-- MONTHLY DEMAND -->
    <section class="panel">
      <h2>
        Monthly demand (FTE) ‚Äì focus roles
        <span class="label" id="monthlyLabel">All years ¬∑ All regions ¬∑ All countries ¬∑ All tech</span>
      </h2>
      <div class="scroll-x">
        <table id="monthlyTable">
          <thead>
            <tr>
              <th>MONTH</th>
              <th>PROJECTS</th>
              <th>MW PV</th>
              <th>MW BESS</th>
              <th>REGIONS</th>
              <th>COUNTRIES</th>
              <th>PV PROJ</th>
              <th>BESS PROJ</th>
              <th>#E&amp;P</th>
              <th>#EPC-Proc</th>
              <th>#EPC-Eng</th>
              <th>#Constr.</th>
              <th>#Comm.</th>
              <th>PD</th>
              <th>PM</th>
              <th>Perm. Mgr</th>
              <th>Proj Eng</th>
              <th>Constr. PM</th>
              <th>Site Mgr</th>
              <th>Qual. Mgr</th>
              <th>H&amp;S Mgr</th>
              <th>LTA Mgr</th>
              <th>P&amp;C Analyst</th>
              <th>Scheduler</th>
              <th>Budget Ctrl.</th>
            </tr>
          </thead>
          <tbody>
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>
      <div class="placeholder">
        Click any month row to see the list of projects active in that month, with their stage and details.
      </div>
    </section>

    <!-- MONTH DETAIL + PROJECT STAFFING -->
    <section class="panel">
      <h2>
        Month details
        <span class="label" id="monthDetailLabel">Select a month in the table above</span>
      </h2>

      <!-- resumen por rol y overload -->
      <div id="monthRolesSummary" class="placeholder">
        Here you‚Äôll see, for the selected month, need vs assigned FTE per role.
      </div>
      <div id="monthOverloadSummary" class="placeholder">
        And here, any people overbooked in that month (FTE assigned &gt; FTE base).
      </div>

      <!-- tabla de proyectos del mes -->
      <div class="scroll-x">
        <table id="monthProjectsTable">
          <thead>
            <tr>
              <th>Project</th>
              <th>Name</th>
              <th>Region</th>
              <th>Country</th>
              <th>Tech</th>
              <th>MW PV</th>
              <th>MW BESS</th>
              <th>Stage (this month)</th>
              <th>Permitting</th>
              <th>Tender Pkg</th>
              <th>Financing</th>
              <th>Start Constr.</th>
              <th>Mech. Compl.</th>
              <th>PAC</th>
            </tr>
          </thead>
          <tbody>
            <!-- filled by JS -->
          </tbody>
        </table>
      </div>

      <!-- PROJECT STAFFING -->
      <div class="project-staffing">
        <div class="project-staffing-header">
          <span>Project staffing ‚Äì select a project to assign people to positions</span>
          <div>
            <select id="projectSelect">
              <option value="">Select a month first</option>
            </select>
          </div>
        </div>
        <div id="projectRolesContainer" class="project-roles-list">
          <div class="muted">Select a month above, then choose a project here or click on a project row.</div>
        </div>
      </div>

      <div class="placeholder">
        Project list shows which projects are active this month. In ‚ÄúProject staffing‚Äù you can assign people from the pool to each role; assignments are stored in the Supabase table <code>assignments</code>.
      </div>
    </section>
  </main>
</div>

<!-- Supabase JS + logic -->
<script type="module">
  const SUPABASE_URL = "https://ascfisqbwvkfdmcskslr.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_KLPwFBTL34aDaQJ7XIHBCA_K8San_bV";

  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM refs
  const regionFilter  = document.getElementById("regionFilter");
  const countryFilter = document.getElementById("countryFilter");
  const techFilter    = document.getElementById("techFilter");
  const yearFilter    = document.getElementById("yearFilter");
  const refreshBtn    = document.getElementById("refreshBtn");

  const summaryRoles    = document.getElementById("summaryRoles");
  const summaryPeople   = document.getElementById("summaryPeople");
  const summaryProjects = document.getElementById("summaryProjects");
  const summaryProjectsExtra = document.getElementById("summaryProjectsExtra");

  const monthlyLabel     = document.getElementById("monthlyLabel");
  const monthlyTableBody = document.querySelector("#monthlyTable tbody");

  const monthDetailLabel   = document.getElementById("monthDetailLabel");
  const monthProjectsBody  = document.querySelector("#monthProjectsTable tbody");
  const monthRolesSummary  = document.getElementById("monthRolesSummary");
  const monthOverloadSummary = document.getElementById("monthOverloadSummary");

  // project staffing refs
  const projectSelect        = document.getElementById("projectSelect");
  const projectRolesContainer = document.getElementById("projectRolesContainer");

  // Data in memory
  let roles = [];
  let people = [];
  let projects = [];
  let assignments = [];
  let projectRoles = [];
  let projectRoleStandard = [];

  // buckets por mes
  let monthlyBuckets = {};
  let currentMonthKey = null;

  const FOCUS_ROLES = [
    "PD",
    "PM",
    "Permitting Manager",
    "Project Engineer",
    "Construction PM",
    "Site Manager",
    "Quality Manager",
    "H&S Manager",
    "LTA Manager",
    "P&C Analyst",
    "Scheduler",
    "Budget Controller"
  ];

  const STAGE_DEMAND_FIELDS = {
    eng_perm:      "eng_perm_demand",
    epc_proc:      "epc_proc_demand",
    epc_eng:       "epc_eng_demand",
    construction:  "construction_demand",
    commissioning: "commissioning_demand"
  };

  const parseDate = (value) => value ? new Date(value + "T00:00:00") : null;
  const monthKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  const monthLabel = (d) => d.toLocaleDateString("en-GB",{year:"numeric",month:"short"});

  function getProjectStages(p){
    const pa  = parseDate(p.permitting_approval_date);
    const tpd = parseDate(p.tender_package_design_date);
    const fs  = parseDate(p.financing_signing_date);
    const cs  = parseDate(p.construction_start_date);
    const mc  = parseDate(p.mechanical_completion_date);
    const pac = parseDate(p.pac_date);

    const stages = [];
    if (pa && tpd) stages.push({stage:"eng_perm", start:pa, end:tpd});
    if (tpd && fs) stages.push({stage:"epc_proc", start:tpd, end:fs});
    if (fs && cs)  stages.push({stage:"epc_eng",  start:fs,  end:cs});
    if (cs && mc)  stages.push({stage:"construction", start:cs, end:mc});
    if (mc && pac) stages.push({stage:"commissioning", start:mc, end:pac});
    return stages;
  }

  function getStageForProjectAtMonth(p, monthDate){
    const stages = getProjectStages(p);
    if (!stages.length) return null;
    const mYear = monthDate.getFullYear();
    const mMonth = monthDate.getMonth();
    for (const st of stages){
      const d = new Date(st.start.getFullYear(), st.start.getMonth(), 1);
      while (d < st.end){
        if (d.getFullYear() === mYear && d.getMonth() === mMonth){
          return st.stage;
        }
        d.setMonth(d.getMonth()+1);
      }
    }
    return null;
  }

  async function loadData(){
    const [rolesRes, peopleRes, projectsRes, assignmentsRes, projRolesRes, projRoleStdRes] =
      await Promise.all([
        supabase.from("roles_capacity").select("*"),
        supabase.from("people").select("*"),
        supabase.from("projects").select("*"),
        supabase.from("assignments").select("*"),
        supabase.from("project_roles").select("*"),
        supabase.from("project_role_standard").select("*")
      ]);

    if (rolesRes.error)        console.error("roles_capacity error", rolesRes.error);
    if (peopleRes.error)       console.error("people error", peopleRes.error);
    if (projectsRes.error)     console.error("projects error", projectsRes.error);
    if (assignmentsRes.error)  console.error("assignments error", assignmentsRes.error);
    if (projRolesRes.error)    console.error("project_roles error", projRolesRes.error);
    if (projRoleStdRes.error)  console.error("project_role_standard error", projRoleStdRes.error);

    roles       = rolesRes.data        || [];
    people      = peopleRes.data       || [];
    projects    = projectsRes.data     || [];
    assignments = assignmentsRes.data  || [];
    projectRoles = projRolesRes.data   || [];
    projectRoleStandard = projRoleStdRes.data || [];

    buildFilterOptions();
    renderSummary();
    buildAndRenderMonthly();
  }

  function buildFilterOptions(){
    const regions = Array.from(new Set(projects.map(p => p.region).filter(Boolean))).sort();
    regionFilter.innerHTML = '<option value="all">All regions</option>' +
      regions.map(r => `<option value="${r}">${r}</option>`).join("");

    const countries = Array.from(new Set(projects.map(p => p.country).filter(Boolean))).sort();
    countryFilter.innerHTML = '<option value="all">All countries</option>' +
      countries.map(c => `<option value="${c}">${c}</option>`).join("");

    const techs = Array.from(new Set(projects.map(p => p.technology).filter(Boolean))).sort();
    techFilter.innerHTML = '<option value="all">All technologies</option>' +
      techs.map(t => `<option value="${t}">${t}</option>`).join("");

    const yearsSet = new Set();
    for (const p of projects){
      const dates = [
        p.permitting_approval_date,
        p.tender_package_design_date,
        p.financing_signing_date,
        p.construction_start_date,
        p.mechanical_completion_date,
        p.pac_date
      ];
      for (const v of dates){
        if (!v) continue;
        const y = Number(v.slice(0,4));
        if (!Number.isNaN(y)) yearsSet.add(y);
      }
    }
    const years = Array.from(yearsSet).sort((a,b) => a-b);
    yearFilter.innerHTML = '<option value="all">All years</option>' +
      years.map(y => `<option value="${y}">${y}</option>`).join("");
  }

  function filteredProjects(){
    return projects.filter(p => {
      if (regionFilter.value !== "all" && p.region !== regionFilter.value) return false;
      if (countryFilter.value !== "all" && p.country !== countryFilter.value) return false;
      if (techFilter.value !== "all" && p.technology !== techFilter.value) return false;
      return true;
    });
  }

  function renderSummary(){
    summaryRoles.textContent  = roles.length;
    summaryPeople.textContent = people.length;
    summaryProjects.textContent = filteredProjects().length;
    summaryProjectsExtra.textContent = "filtered by region / country / tech";
  }

  function buildAndRenderMonthly(){
    const filtered = filteredProjects();
    monthlyTableBody.innerHTML = "";
    monthProjectsBody.innerHTML = "";
    monthDetailLabel.textContent = "Select a month in the table above";
    monthRolesSummary.textContent = "Here you‚Äôll see, for the selected month, need vs assigned FTE per role.";
    monthOverloadSummary.textContent = "And here, any people overbooked in that month (FTE assigned > FTE base).";
    projectSelect.innerHTML = '<option value="">Select a month first</option>';
    projectRolesContainer.innerHTML = '<div class="muted">Select a month above, then choose a project here or click on a project row.</div>';
    currentMonthKey = null;

    if (!filtered.length) {
      monthlyBuckets = {};
      return;
    }

    const roleByName = {};
    for (const r of roles){
      roleByName[r.role_name] = r;
    }

    let minDate = null;
    let maxDate = null;
    for (const p of filtered){
      const dates = [
        p.permitting_approval_date,
        p.tender_package_design_date,
        p.financing_signing_date,
        p.construction_start_date,
        p.mechanical_completion_date,
        p.pac_date
      ].map(parseDate).filter(Boolean);
      for (const d of dates){
        if (!minDate || d < minDate) minDate = d;
        if (!maxDate || d > maxDate) maxDate = d;
      }
    }
    if (!minDate || !maxDate) {
      monthlyBuckets = {};
      return;
    }

    const yearVal = yearFilter.value;
    const monthly = {};

    for (const p of filtered){
      const stages = getProjectStages(p);
      if (!stages.length) continue;

      for (const st of stages){
        const cursor = new Date(st.start.getFullYear(), st.start.getMonth(), 1);
        while (cursor < st.end){
          const y = cursor.getFullYear();
          if (yearVal !== "all" && String(y) !== yearVal){
            cursor.setMonth(cursor.getMonth()+1);
            continue;
          }
          const key = monthKey(cursor);
          if (!monthly[key]){
            monthly[key] = {
              date: new Date(cursor.getTime()),
              totalProjects: new Set(),
              mwPV: 0,
              mwBESS: 0,
              regions: new Set(),
              countries: new Set(),
              pvProjects: new Set(),
              bessProjects: new Set(),
              stageCounts: {
                eng_perm:0, epc_proc:0, epc_eng:0, construction:0, commissioning:0
              },
              rolesDemand: {}
            };
            for (const rName of FOCUS_ROLES){
              monthly[key].rolesDemand[rName] = 0;
            }
          }
          const bucket = monthly[key];

          bucket.totalProjects.add(p.id);

          const projMwPV   = Number(p.mw_pv   || 0);
          const projMwBESS = Number(p.mw_bess || 0);
          bucket.mwPV   += projMwPV;
          bucket.mwBESS += projMwBESS;

          if (p.region)  bucket.regions.add(p.region);
          if (p.country) bucket.countries.add(p.country);

          const tech = (p.technology || "").toLowerCase();
          if (tech.includes("battery") || tech.includes("bess")){
            bucket.bessProjects.add(p.id);
          } else if (tech){
            bucket.pvProjects.add(p.id);
          }

          bucket.stageCounts[st.stage]++;

          for (const roleName of FOCUS_ROLES){
            const rc = roleByName[roleName];
            if (!rc) continue;
            const field  = STAGE_DEMAND_FIELDS[st.stage];
            const demand = Number(rc[field] || 0);
            bucket.rolesDemand[roleName] += demand;
          }

          cursor.setMonth(cursor.getMonth()+1);
        }
      }
    }

    monthlyBuckets = monthly;

    const keys = Object.keys(monthly).sort();
    for (const key of keys){
      const b = monthly[key];
      const label = monthLabel(b.date);
      const rd = b.rolesDemand;

      const tr = document.createElement("tr");
      tr.dataset.monthKey = key;
      tr.innerHTML = `
        <td style="text-align:left">${label}</td>
        <td>${b.totalProjects.size}</td>
        <td>${b.mwPV.toFixed(1)}</td>
        <td>${b.mwBESS.toFixed(1)}</td>
        <td>${b.regions.size}</td>
        <td>${b.countries.size}</td>
        <td>${b.pvProjects.size}</td>
        <td>${b.bessProjects.size}</td>
        <td>${b.stageCounts.eng_perm}</td>
        <td>${b.stageCounts.epc_proc}</td>
        <td>${b.stageCounts.epc_eng}</td>
        <td>${b.stageCounts.construction}</td>
        <td>${b.stageCounts.commissioning}</td>
        <td>${rd["PD"].toFixed(2)}</td>
        <td>${rd["PM"].toFixed(2)}</td>
        <td>${rd["Permitting Manager"].toFixed(2)}</td>
        <td>${rd["Project Engineer"].toFixed(2)}</td>
        <td>${rd["Construction PM"].toFixed(2)}</td>
        <td>${rd["Site Manager"].toFixed(2)}</td>
        <td>${rd["Quality Manager"].toFixed(2)}</td>
        <td>${rd["H&S Manager"].toFixed(2)}</td>
        <td>${rd["LTA Manager"].toFixed(2)}</td>
        <td>${rd["P&C Analyst"].toFixed(2)}</td>
        <td>${rd["Scheduler"].toFixed(2)}</td>
        <td>${rd["Budget Controller"].toFixed(2)}</td>
      `;
      tr.addEventListener("click", () => showMonthDetail(key));
      monthlyTableBody.appendChild(tr);
    }

    const labYear   = (yearVal === "all" ? "All years" : yearVal);
    const labRegion = regionFilter.value === "all" ? "All regions"   : regionFilter.value;
    const labCountry= countryFilter.value === "all" ? "All countries" : countryFilter.value;
    const labTech   = techFilter.value === "all" ? "All tech"       : techFilter.value;
    monthlyLabel.textContent = `${labYear} ¬∑ ${labRegion} ¬∑ ${labCountry} ¬∑ ${labTech}`;
  }

  function showMonthDetail(monthKeyStr){
    currentMonthKey = monthKeyStr;

    const [yStr, mStr] = monthKeyStr.split("-");
    const year = Number(yStr);
    const monthIndex = Number(mStr) - 1;
    const dMonth = new Date(year, monthIndex, 1);
    const monthStart = new Date(year, monthIndex, 1);
    const monthEnd   = new Date(year, monthIndex + 1, 1);

    const filtered = filteredProjects();
    monthProjectsBody.innerHTML = "";

    const monthProjects = [];

    for (const p of filtered){
      const stage = getStageForProjectAtMonth(p, dMonth);
      if (!stage) continue;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="text-align:left">${p.project_code || ""}</td>
        <td style="text-align:left">${p.project_name || ""}</td>
        <td>${p.region || ""}</td>
        <td>${p.country || ""}</td>
        <td>${p.technology || ""}</td>
        <td>${p.mw_pv ?? ""}</td>
        <td>${p.mw_bess ?? ""}</td>
        <td>${stage}</td>
        <td>${p.permitting_approval_date || ""}</td>
        <td>${p.tender_package_design_date || ""}</td>
        <td>${p.financing_signing_date || ""}</td>
        <td>${p.construction_start_date || ""}</td>
        <td>${p.mechanical_completion_date || ""}</td>
        <td>${p.pac_date || ""}</td>
      `;
      tr.addEventListener("click", () => {
        projectSelect.value = p.id;
        showProjectStaffing(p.id);
      });
      monthProjectsBody.appendChild(tr);
      monthProjects.push(p);
    }

    const label = dMonth.toLocaleDateString("en-GB",{year:"numeric",month:"long"});
    monthDetailLabel.textContent = `Month: ${label} ‚Äì ${filtered.length} projects in filter`;

    // rellenar selector de proyectos
    if (monthProjects.length){
      projectSelect.disabled = false;
      projectSelect.innerHTML =
        '<option value="">Select project‚Ä¶</option>' +
        monthProjects.map(p =>
          `<option value="${p.id}">${p.project_code || p.project_name || p.id}</option>`
        ).join("");
    } else {
      projectSelect.disabled = true;
      projectSelect.innerHTML = '<option value="">No projects this month</option>';
      projectRolesContainer.innerHTML = '<div class="muted">No projects in this month with current filters.</div>';
    }

    // resumen NEED vs ASSIGNED
    const bucket = monthlyBuckets[monthKeyStr];
    const demandPerRole = bucket ? bucket.rolesDemand : null;

    const projSet = new Set(filtered.map(p => p.id));
    const assignedPerRole = {};
    for (const r of FOCUS_ROLES){
      assignedPerRole[r] = 0;
    }

    const ftePerPerson = {};

    for (const a of assignments){
      if (!projSet.has(a.project_id)) continue;

      const aStart = parseDate(a.start_date);
      const aEnd   = a.end_date ? parseDate(a.end_date) : null;
      if (!aStart) continue;

      const overlaps =
        aStart < monthEnd &&
        (!aEnd || aEnd >= monthStart);

      if (!overlaps) continue;

      const fte = Number(a.fte_on_project || 0);
      const roleName = a.role_name;

      if (FOCUS_ROLES.includes(roleName)){
        assignedPerRole[roleName] += fte;
      }

      if (!ftePerPerson[a.person_id]) ftePerPerson[a.person_id] = 0;
      ftePerPerson[a.person_id] += fte;
    }

    if (demandPerRole){
      let html = '<div class="month-roles-grid">';
      for (const role of FOCUS_ROLES){
        const need = demandPerRole[role] || 0;
        const have = assignedPerRole[role] || 0;
        const gap = need - have;
        let statusClass = "";
        let gapText = "Balanced";
        if (gap > 0.05){
          statusClass = "missing";
          gapText = `Missing ${gap.toFixed(1)} FTE`;
        } else if (gap < -0.05){
          statusClass = "excess";
          gapText = `Excess ${(-gap).toFixed(1)} FTE`;
        }
        html += `
          <div class="role-card ${statusClass}">
            <div class="role-name">${role}</div>
            <div class="role-values">
              <span>${need.toFixed(1)} need</span>
              <span>${have.toFixed(1)} assigned</span>
            </div>
            <div class="role-gap">${gapText}</div>
          </div>
        `;
      }
      html += "</div>";
      monthRolesSummary.innerHTML = html;
    } else {
      monthRolesSummary.textContent = "No monthly demand calculated for this month.";
    }

    const peopleById = {};
    for (const p of people){
      peopleById[p.id] = p;
    }

    const overloaded = [];
    for (const [personId, totalFte] of Object.entries(ftePerPerson)){
      const person = peopleById[personId];
      const base = Number(person?.fte_base || 1);
      if (totalFte > base + 0.01){
        overloaded.push({
          person,
          totalFte,
          base,
          over: totalFte - base
        });
      }
    }

    if (overloaded.length){
      overloaded.sort((a,b) => b.over - a.over);
      const items = overloaded.map(o => {
        const name = o.person?.full_name || "Unknown";
        return `<li><strong>${name}</strong> ‚Äì assigned ${o.totalFte.toFixed(2)} FTE vs base ${o.base.toFixed(2)} (over by ${o.over.toFixed(2)})</li>`;
      }).join("");
      monthOverloadSummary.innerHTML = `
        <div class="muted">People overload this month (consider rebalancing or hiring):</div>
        <ul class="overload-list">${items}</ul>
      `;
    } else {
      monthOverloadSummary.innerHTML = `<span class="muted">No overload detected for this month (based on FTE assignments).</span>`;
    }
  }

  function showProjectStaffing(projectId){
    const project = projects.find(p => p.id === projectId);
    if (!project){
      projectRolesContainer.innerHTML = '<div class="muted">Project not found.</div>';
      return;
    }

    // roles espec√≠ficos del proyecto, o plantilla est√°ndar si no hay
    let rolesForProject = projectRoles.filter(r => r.project_id === projectId);
    if (!rolesForProject.length){
      rolesForProject = projectRoleStandard.map(r => ({
        project_id: projectId,
        role_name: r.role_name,
        slots: r.default_slots || 1
      }));
    }

    if (!rolesForProject.length){
      projectRolesContainer.innerHTML = '<div class="muted">No roles defined for this project.</div>';
      return;
    }

    const peopleById = {};
    for (const p of people){ peopleById[p.id] = p; }

    let html = "";
    for (const pr of rolesForProject){
      const roleName = pr.role_name;
      const slots = pr.slots ?? 1;

      const assignedThisRole = assignments.filter(a =>
        a.project_id === projectId && a.role_name === roleName
      );

      const assignedText = assignedThisRole.length
        ? assignedThisRole.map(a => {
            const person = peopleById[a.person_id];
            const name = person?.full_name || "Unknown";
            const f = Number(a.fte_on_project || 0);
            return `${name} (${f.toFixed(2)} FTE)`;
          }).join(", ")
        : "No one assigned";

      const candidates = people.filter(p =>
        p.role_name === roleName &&
        (p.permanent_active ?? true)
      );

      const selectId = `assign_${projectId}_${roleName.replace(/[^a-zA-Z0-9]/g,"_")}`;

      const optionsHtml = candidates.length
        ? '<option value="">Select person‚Ä¶</option>' +
          candidates.map(c => `<option value="${c.id}">${c.full_name || c.id}</option>`).join("")
        : '<option value="">No available people with this role</option>';

      html += `
        <div class="proj-role-row">
          <div class="proj-role-main">
            <div class="proj-role-name">${roleName}</div>
            <div class="proj-role-meta">${slots} slot(s) ¬∑ ${assignedThisRole.length} assigned</div>
            <div class="proj-role-assigned"><span class="muted">Assigned:</span> ${assignedText}</div>
          </div>
          <div class="proj-role-actions">
            <select id="${selectId}" data-role="${roleName}">
              ${optionsHtml}
            </select>
            <button class="primary assign-btn" data-project="${projectId}" data-role="${roleName}" data-select-id="${selectId}">
              Assign
            </button>
          </div>
        </div>
      `;
    }

    projectRolesContainer.innerHTML = html;

    // listeners de botones Assign
    projectRolesContainer.querySelectorAll(".assign-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const projectId = btn.dataset.project;
        const roleName = btn.dataset.role;
        const selectId = btn.dataset.selectId;
        await handleAssignClick(projectId, roleName, selectId);
      });
    });
  }

   async function handleAssignClick(projectId, roleName, selectId){
    const selectEl = document.getElementById(selectId);
    if (!selectEl){
      alert("Internal error: select not found");
      return;
    }
    const personId = selectEl.value;
    if (!personId){
      alert("Select a person first.");
      return;
    }
    if (!currentMonthKey){
      alert("Select a month first.");
      return;
    }

    const [yStr, mStr] = currentMonthKey.split("-");
    const year = Number(yStr);
    const monthIndex = Number(mStr) - 1;

    const startDate = `${year}-${String(monthIndex+1).padStart(2,"0")}-01`;
    const endDateObj = new Date(year, monthIndex + 1, 0); // √∫ltimo d√≠a del mes
    const endDate = `${endDateObj.getFullYear()}-${String(endDateObj.getMonth()+1).padStart(2,"0")}-${String(endDateObj.getDate()).padStart(2,"0")}`;

    // üîπ calcular stage del proyecto en ese mes (si existe)
    const project = projects.find(p => p.id === projectId);
    let stage = null;
    if (project){
      const monthDate = new Date(year, monthIndex, 1);
      stage = getStageForProjectAtMonth(project, monthDate);
    }

    // üîπ payload completo: id + stage + dem√°s columnas
    const payload = {
      id: crypto.randomUUID(),          // por si id es NOT NULL sin default
      project_id: projectId,
      person_id: personId,
      role_name: roleName,
      stage: stage || null,             // si la columna es NOT NULL, aseg√∫rate de tener valor v√°lido
      fte_on_project: 1,
      start_date: startDate,
      end_date: endDate
    };

    const { data, error } = await supabase
      .from("assignments")
      .insert(payload)
      .select()
      .single();

    if (error){
      console.error("Error inserting assignment", error);
      alert("Error assigning person: " + (error.message || JSON.stringify(error)));
      return;
    }

    // guardar en memoria y refrescar vistas
    assignments.push(data);
    showProjectStaffing(projectId);
    showMonthDetail(currentMonthKey);
  }


  // eventos filtros
  [regionFilter, countryFilter, techFilter, yearFilter].forEach(el => {
    el.addEventListener("change", () => {
      renderSummary();
      buildAndRenderMonthly();
    });
  });

  projectSelect.addEventListener("change", () => {
    const projectId = projectSelect.value;
    if (!projectId){
      projectRolesContainer.innerHTML = '<div class="muted">Select a project to see its roles and assignments.</div>';
      return;
    }
    showProjectStaffing(projectId);
  });

  refreshBtn.addEventListener("click", loadData);

  loadData();
</script>
</body>
</html>
