<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Headcount – Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#050816;
      --panel:#0b1220;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,.15);
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f97373;
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%);
      color:var(--ink);
      min-height:100vh;
      padding:16px;
    }
    .app{
      max-width:1400px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    h1{
      font-size:1.4rem;
      letter-spacing:.03em;
    }
    .subtitle{
      font-size:.85rem;
      color:var(--muted);
    }
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }
    select,input,button{
      background:rgba(15,23,42,.9);
      color:var(--ink);
      border:1px solid rgba(148,163,184,.6);
      border-radius:999px;
      padding:6px 12px;
      font-size:.8rem;
      outline:none;
    }
    button.primary{
      border-color:var(--accent);
      background:var(--accent-soft);
      cursor:pointer;
    }
    main{
      display:grid;
      grid-template-columns:2fr 3fr;
      grid-template-rows:auto auto auto;
      gap:16px;
    }
    @media (max-width:980px){
      main{
        grid-template-columns:1fr;
        grid-template-rows:auto;
      }
    }
    .panel{
      background:rgba(15,23,42,.9);
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.4);
      padding:12px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
    }
    .panel h2{
      font-size:.95rem;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .panel h2 span.label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .summary-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width:700px){
      .summary-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    .card{
      background:radial-gradient(circle at top,var(--accent-soft),rgba(15,23,42,.95));
      border-radius:var(--radius);
      padding:10px 12px;
      border:1px solid rgba(148,163,184,.4);
    }
    .card-label{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .card-value{
      font-size:1.3rem;
      margin-top:4px;
    }
    .card-extra{
      font-size:.75rem;
      margin-top:2px;
      color:var(--muted);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:.78rem;
    }
    th,td{
      padding:6px 4px;
      text-align:left;
      border-bottom:1px solid rgba(31,41,55,.8);
      vertical-align:middle;
    }
    th{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
      position:sticky;
      top:0;
      background:rgba(15,23,42,.98);
      z-index:1;
    }
    tbody tr:nth-child(even){
      background-color:rgba(15,23,42,.7);
    }
    tbody tr:hover{
      background-color:rgba(55,65,81,.8);
      cursor:pointer;
    }
    .muted{ color:var(--muted); }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.4);
      font-size:.7rem;
      display:inline-flex;
      gap:4px;
      align-items:center;
    }
    .pill strong{ color:var(--accent); }
    .placeholder{
      font-size:.8rem;
      color:var(--muted);
      padding:8px 2px 2px;
    }
    .subtable{
      margin-top:8px;
      max-height:220px;
      overflow:auto;
    }
    .clickable-row{
      cursor:pointer;
    }
    .clickable-row:hover{
      background-color:rgba(55,65,81,.9);
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Project Headcount – Command Center</h1>
      <div class="subtitle">Supabase · Roles · People · Projects · 2025–2027</div>
    </div>
    <div class="filters">
      <select id="regionFilter">
        <option value="all">All regions</option>
      </select>
      <select id="countryFilter">
        <option value="all">All countries</option>
      </select>
      <select id="techFilter">
        <option value="all">All technologies</option>
      </select>
      <select id="projectFilter">
        <option value="all">All projects</option>
      </select>
      <select id="yearFilter">
        <option value="">Year…</option>
      </select>
      <button class="primary" id="refreshBtn">Refresh data</button>
    </div>
  </header>

  <main>
    <!-- SUMMARY -->
    <section class="panel">
      <h2>
        Overview
        <span class="label">Snapshot</span>
      </h2>
      <div class="summary-grid">
        <div class="card">
          <div class="card-label">Roles</div>
          <div class="card-value" id="summaryRoles">–</div>
          <div class="card-extra muted" id="summaryRolesExtra">from roles_capacity</div>
        </div>
        <div class="card">
          <div class="card-label">People</div>
          <div class="card-value" id="summaryPeople">–</div>
          <div class="card-extra muted" id="summaryPeopleExtra">internal + OE</div>
        </div>
        <div class="card">
          <div class="card-label">Projects</div>
          <div class="card-value" id="summaryProjects">–</div>
          <div class="card-extra muted" id="summaryProjectsExtra">filtered set</div>
        </div>
      </div>
      <div class="placeholder">
        Later: quick alerts like <strong>“PM overbooked in IT Q2 2026”</strong>, etc.
      </div>
    </section>

    <!-- ROLES / CAPACITY TABLE -->
    <section class="panel">
      <h2>
        Roles capacity by region
        <span class="label"><span id="regionLabel">All regions</span></span>
      </h2>
      <div style="max-height:260px;overflow:auto;">
        <table id="rolesTable">
          <thead>
            <tr>
              <th>Role</th>
              <th>Dept</th>
              <th>Max alloc</th>
              <th>Internal FTE</th>
              <th>OE FTE</th>
              <th>Total FTE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PROJECTS TABLE -->
    <section class="panel">
      <h2>
        Projects
        <span class="label">2025–2027 window</span>
      </h2>
      <div style="max-height:260px;overflow:auto;">
        <table id="projectsTable">
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Region</th>
              <th>Country</th>
              <th>Tech</th>
              <th>Capacity MW</th>
              <th>Status</th>
              <th>Start constr.</th>
              <th>PAC</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="placeholder">
        Later here: mini-Gantt, filters by year/quarter, click → open org chart view.
      </div>
    </section>

    <!-- MONTHLY DEMAND + DETAIL -->
    <section class="panel">
      <h2>
        Monthly demand (FTE) – Focus roles
        <span class="label"><span id="monthContextLabel">Select year</span></span>
      </h2>
      <div style="max-height:220px;overflow:auto;">
        <table id="monthlyTable">
          <thead>
            <tr>
              <th>Month</th>
              <th>PD</th>
              <th>PM</th>
              <th>Perm.</th>
              <th>Site Mgr</th>
              <th>Qual. Mgr</th>
              <th>H&amp;S Mgr</th>
              <th>Proj Eng</th>
              <th>Constr. Mgr</th>
              <th>#Proj</th>
              <th>MW</th>
              <th>PV proj</th>
              <th>BESS proj</th>
              <th>#Regions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="placeholder" id="monthDetail">
        Click a month row to see the list of projects active in that month, their stage, MW, region, etc.
      </div>
    </section>
  </main>
</div>

<!-- Supabase JS -->
<script type="module">
  // Usa tu URL y anon key (publishable) de Supabase
  const SUPABASE_URL = "https://ascfisqbwvkfdmcskslr.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_KLPwFBTL34aDaQJ7XIHBCA_K8San_bV";

  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Filtros
  const regionFilter  = document.getElementById("regionFilter");
  const countryFilter = document.getElementById("countryFilter");
  const techFilter    = document.getElementById("techFilter");
  const projectFilter = document.getElementById("projectFilter");
  const yearFilter    = document.getElementById("yearFilter");
  const refreshBtn    = document.getElementById("refreshBtn");
  const regionLabel   = document.getElementById("regionLabel");
  const monthContextLabel = document.getElementById("monthContextLabel");

  // Tablas / summary
  const rolesTableBody    = document.querySelector("#rolesTable tbody");
  const projectsTableBody = document.querySelector("#projectsTable tbody");
  const monthlyTableBody  = document.querySelector("#monthlyTable tbody");
  const monthDetailDiv    = document.getElementById("monthDetail");

  const summaryRoles    = document.getElementById("summaryRoles");
  const summaryPeople   = document.getElementById("summaryPeople");
  const summaryProjects = document.getElementById("summaryProjects");

  // Datos en memoria
  let roles = [];
  let rolesByName = {};
  let people = [];
  let projects = [];
  let projectRoleReq = [];   // project_role_requirements
  let prrMap = {};           // { project_id : { role_name: slots } }

  // Roles foco para demanda mensual
  const FOCUS_ROLES = [
    { roleName:"PD",                 label:"PD",          defaultSlots:1 },
    { roleName:"PM",                 label:"PM",          defaultSlots:1 },
    { roleName:"Permitting Manager", label:"Perm.",       defaultSlots:1 },
    { roleName:"Site Manager",       label:"Site Mgr",    defaultSlots:2 },
    { roleName:"Quality Manager",    label:"Qual. Mgr",   defaultSlots:1 },
    { roleName:"H&S Manager",        label:"H&S Mgr",     defaultSlots:1 },
    { roleName:"Project Engineer",   label:"Proj Eng",    defaultSlots:1 },
    { roleName:"Head of Construction", label:"Constr. Mgr", defaultSlots:1 }
  ];

  const STAGE_LABELS = {
    eng_perm: "Eng & Perm",
    epc_proc: "EPC Proc",
    epc_eng: "EPC Eng",
    construction: "Construction",
    commissioning: "Commissioning"
  };

  async function loadData(){
    const [rolesRes, peopleRes, projectsRes, prrRes] = await Promise.all([
      supabase.from("roles_capacity").select("*"),
      supabase.from("people").select("*"),
      supabase.from("projects").select("*"),
      supabase.from("project_role_requirements").select("*")
    ]);

    if(rolesRes.error)   console.error("roles_capacity error", rolesRes.error);
    if(peopleRes.error)  console.error("people error", peopleRes.error);
    if(projectsRes.error)console.error("projects error", projectsRes.error);
    if(prrRes.error)     console.error("project_role_requirements error", prrRes.error);

    roles    = rolesRes.data  || [];
    people   = peopleRes.data || [];
    projectRoleReq = prrRes.data || [];

    // Mapa de roles por nombre
    rolesByName = {};
    for(const r of roles){
      rolesByName[r.role_name] = r;
    }

    // Enriquecer proyectos con fechas JS
    projects = (projectsRes.data || []).map(p => ({
      ...p,
      _pa:  p.permitting_approval_date      ? new Date(p.permitting_approval_date)      : null,
      _tpd: p.tender_package_design_date    ? new Date(p.tender_package_design_date)    : null,
      _fs:  p.financing_signing_date        ? new Date(p.financing_signing_date)        : null,
      _cs:  p.construction_start_date       ? new Date(p.construction_start_date)       : null,
      _mc:  p.mechanical_completion_date    ? new Date(p.mechanical_completion_date)    : null,
      _pac: p.pac_date                      ? new Date(p.pac_date)                      : null
    }));

    // Mapa de slots por proyecto/rol
    prrMap = {};
    for(const row of projectRoleReq){
      if(!prrMap[row.project_id]) prrMap[row.project_id] = {};
      prrMap[row.project_id][row.role_name] = row.slots;
    }

    updateFiltersFromProjects();
    renderSummary();
    renderRolesTable();
    renderProjectsTable();
    renderMonthlyTable();
  }

  function updateFiltersFromProjects(){
    const regions = new Set();
    const countries = new Set();
    const techs = new Set();
    const years = new Set();

    for(const p of projects){
      if(p.region) regions.add(p.region);
      if(p.country) countries.add(p.country);
      if(p.technology) techs.add(p.technology);

      const dates = [p.permitting_approval_date, p.tender_package_design_date,
                     p.financing_signing_date, p.construction_start_date,
                     p.mechanical_completion_date, p.pac_date];
      for(const d of dates){
        if(d){
          const y = new Date(d).getFullYear();
          years.add(y);
        }
      }
    }

    regionFilter.innerHTML =
      '<option value="all">All regions</option>' +
      Array.from(regions).sort().map(r => `<option value="${r}">${r}</option>`).join("");

    countryFilter.innerHTML =
      '<option value="all">All countries</option>' +
      Array.from(countries).sort().map(c => `<option value="${c}">${c}</option>`).join("");

    techFilter.innerHTML =
      '<option value="all">All technologies</option>' +
      Array.from(techs).sort().map(t => `<option value="${t}">${t}</option>`).join("");

    projectFilter.innerHTML =
      '<option value="all">All projects</option>' +
      projects.map(p => `<option value="${p.id}">${p.project_code || p.project_name}</option>`).join("");

    const yearsArr = Array.from(years).sort();
    yearFilter.innerHTML =
      '<option value="">Year…</option>' +
      yearsArr.map(y => `<option value="${y}">${y}</option>`).join("");

    if(!yearFilter.value && yearsArr.length){
      yearFilter.value = yearsArr[0];
    }
  }

  function getFilteredProjects(){
    const r = regionFilter.value;
    const c = countryFilter.value;
    const t = techFilter.value;
    const pid = projectFilter.value;

    return projects.filter(p => {
      if(r !== "all" && p.region !== r) return false;
      if(c !== "all" && p.country !== c) return false;
      if(t !== "all" && p.technology !== t) return false;
      if(pid !== "all" && p.id !== pid) return false;
      return true;
    });
  }

  function filteredPeople(){
    const r = regionFilter.value;
    if(r === "all") return people;
    return people.filter(p => p.region === r);
  }

  function renderSummary(){
    const projs = getFilteredProjects();
    summaryRoles.textContent    = roles.length;
    summaryPeople.textContent   = people.length;
    summaryProjects.textContent = projs.length;
    regionLabel.textContent = regionFilter.value === "all" ? "All regions" : regionFilter.value;
  }

  function renderRolesTable(){
    const regionPeople = filteredPeople();

    const agg = {};
    for(const person of regionPeople){
      const key = person.role_name;
      if(!agg[key]) agg[key] = { internal:0, oe:0, external:0 };
      const type = person.type || "internal";
      agg[key][type] += Number(person.fte_base || 0);
    }

    rolesTableBody.innerHTML = "";
    for(const role of roles){
      const rowAgg = agg[role.role_name] || { internal:0, oe:0, external:0 };
      const internalFte = rowAgg.internal.toFixed(2);
      const oeFte       = rowAgg.oe.toFixed(2);
      const totalFte    = (rowAgg.internal + rowAgg.oe + rowAgg.external).toFixed(2);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${role.role_name}</td>
        <td class="muted">${role.department}</td>
        <td>${Number(role.max_project_allocation || 0).toFixed(2)}</td>
        <td>${internalFte}</td>
        <td>${oeFte}</td>
        <td>${totalFte}</td>
      `;
      rolesTableBody.appendChild(tr);
    }
  }

  function renderProjectsTable(){
    const rows = getFilteredProjects();
    projectsTableBody.innerHTML = "";
    for(const p of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.project_code || ""}</td>
        <td>${p.project_name || ""}</td>
        <td>${p.region || ""}</td>
        <td>${p.country || ""}</td>
        <td>${p.technology || ""}</td>
        <td>${p.capacity_mw ?? ""}</td>
        <td><span class="pill"><strong>${p.status || ""}</strong></span></td>
        <td>${p.construction_start_date || ""}</td>
        <td>${p.pac_date || ""}</td>
      `;
      projectsTableBody.appendChild(tr);
    }
  }

  function getStageForDate(project, date){
    const { _pa, _tpd, _fs, _cs, _mc, _pac } = project;
    if(!_pa || !_pac) return null;
    if(date < _pa || date > _pac) return null;

    if(_tpd && date < _tpd) return "eng_perm";
    if(_fs  && date < _fs)  return "epc_proc";
    if(_cs  && date < _cs)  return "epc_eng";
    if(_mc  && date < _mc)  return "construction";
    return "commissioning";
  }

  function computeMonthlyDemand(){
    const year = parseInt(yearFilter.value,10);
    if(!year) return [];

    const months = [];
    for(let m=0; m<12; m++){
      const label = new Date(year, m, 1).toLocaleString("en",{month:"short"});
      months.push({
        year,
        monthIndex:m,
        label,
        roleDemand:{},          // role_name -> FTE
        projectCount:0,
        totalMw:0,
        pvCount:0,
        bessCount:0,
        regions:new Set(),
        projects:[]             // { project, stage }
      });
    }

    const projs = getFilteredProjects();

    for(const p of projs){
      for(let m=0; m<12; m++){
        const midMonth = new Date(year, m, 15);
        const stage = getStageForDate(p, midMonth);
        if(!stage) continue;

        const bucket = months[m];
        bucket.projectCount += 1;
        bucket.totalMw += Number(p.capacity_mw || 0);
        if(p.technology === "PV")   bucket.pvCount += 1;
        if(p.technology === "BESS") bucket.bessCount += 1;
        if(p.region) bucket.regions.add(p.region);
        bucket.projects.push({ project:p, stage });

        for(const fr of FOCUS_ROLES){
          const roleName = fr.roleName;
          const roleDef  = rolesByName[roleName];
          if(!roleDef) continue;

          const slots =
            (prrMap[p.id] && prrMap[p.id][roleName] != null)
              ? prrMap[p.id][roleName]
              : fr.defaultSlots;

          if(!slots) continue;

          let demandPerProject = 0;
          switch(stage){
            case "eng_perm":
              demandPerProject = Number(roleDef.eng_perm_demand || 0); break;
            case "epc_proc":
              demandPerProject = Number(roleDef.epc_proc_demand || 0); break;
            case "epc_eng":
              demandPerProject = Number(roleDef.epc_eng_demand || 0); break;
            case "construction":
              demandPerProject = Number(roleDef.construction_demand || 0); break;
            case "commissioning":
              demandPerProject = Number(roleDef.commissioning_demand || 0); break;
          }
          const add = demandPerProject * slots;
          if(!bucket.roleDemand[roleName]) bucket.roleDemand[roleName] = 0;
          bucket.roleDemand[roleName] += add;
        }
      }
    }

    return months;
  }

  function renderMonthlyTable(){
    const months = computeMonthlyDemand();
    const year = yearFilter.value;
    monthlyTableBody.innerHTML = "";

    if(!year){
      monthContextLabel.textContent = "Select year";
      monthDetailDiv.textContent = "Select a year to compute monthly demand.";
      return;
    }
    monthContextLabel.textContent = `Year ${year}`;

    for(const m of months){
      const tr = document.createElement("tr");
      tr.classList.add("clickable-row");
      tr.dataset.monthIndex = String(m.monthIndex);

      const cells = [];
      cells.push(`<td>${m.label}</td>`);

      for(const fr of FOCUS_ROLES){
        const v = m.roleDemand[fr.roleName] || 0;
        cells.push(`<td>${v.toFixed(1)}</td>`);
      }

      cells.push(`<td>${m.projectCount}</td>`);
      cells.push(`<td>${m.totalMw.toFixed(1)}</td>`);
      cells.push(`<td>${m.pvCount}</td>`);
      cells.push(`<td>${m.bessCount}</td>`);
      cells.push(`<td>${m.regions.size}</td>`);

      tr.innerHTML = cells.join("");
      tr.addEventListener("click", () => showMonthDetail(m));
      monthlyTableBody.appendChild(tr);
    }

    if(months.length){
      monthDetailDiv.textContent =
        "Click any row above to see detailed list of projects active in that month.";
    } else {
      monthDetailDiv.textContent = "No data for selected filters/year.";
    }
  }

  function showMonthDetail(monthData){
    if(!monthData.projects.length){
      monthDetailDiv.textContent = `No projects active in ${monthData.label} ${monthData.year} for current filters.`;
      return;
    }
    let html = `
      <div class="pill">
        <span><strong>${monthData.label} ${monthData.year}</strong></span>
        <span>${monthData.projectCount} projects</span>
        <span>${monthData.totalMw.toFixed(1)} MW</span>
        <span>${monthData.regions.size} regions</span>
        <span>${monthData.pvCount} PV · ${monthData.bessCount} BESS</span>
      </div>
      <div class="subtable">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Region</th>
              <th>Country</th>
              <th>Tech</th>
              <th>MW</th>
              <th>Stage</th>
            </tr>
          </thead>
          <tbody>
    `;

    for(const item of monthData.projects){
      const p = item.project;
      const stageLabel = STAGE_LABELS[item.stage] || item.stage;
      html += `
        <tr>
          <td>${p.project_code || ""}</td>
          <td>${p.project_name || ""}</td>
          <td>${p.region || ""}</td>
          <td>${p.country || ""}</td>
          <td>${p.technology || ""}</td>
          <td>${p.capacity_mw ?? ""}</td>
          <td>${stageLabel}</td>
        </tr>
      `;
    }

    html += "</tbody></table></div>";
    monthDetailDiv.innerHTML = html;
  }

  // Eventos de filtros
  for(const el of [regionFilter, countryFilter, techFilter, projectFilter, yearFilter]){
    el.addEventListener("change", () => {
      renderSummary();
      renderRolesTable();
      renderProjectsTable();
      renderMonthlyTable();
    });
  }

  refreshBtn.addEventListener("click", loadData);

  // Carga inicial
  loadData();
</script>
</body>
</html>
